import{r as n,j as e,C as q,B as o,l as N,w as U,i as a,O as D,I as z,h as j,G as O,P as ge,m as T,n as F,S as H,o as I,Q as ye,v as G,y as se,p as ve,q as Se,s as Ie,t as Ce}from"./mui-B3kyuV6P.js";import{u as Pe,s as W,h as we}from"./index-B_Yhp6yg.js";import{c as ke}from"./SubmissionBuilder-Dxlags93.js";import{b as Ue,u as De}from"./router-Dq9hdC_f.js";import{E as ze,H as M,U as Te,F as te,D as Fe,S as He,R as We,P as Be,a as Ee,b as Ve,c as Ae}from"./mui-icons-Dh0F4x5g.js";import"./react--cgwBsGs.js";import"./api-xsH4HHeE.js";const $e=()=>{const{submissionId:y}=Ue(),Y=De(),{user:b}=Pe(),[v,ie]=n.useState(null),[i,B]=n.useState(null),[h,E]=n.useState(""),[x,V]=n.useState(""),[m,A]=n.useState(""),[p,$]=n.useState(null),[re,J]=n.useState(!0),[d,Q]=n.useState(!1),[f,_]=n.useState(!1),[K,l]=n.useState(""),[X,g]=n.useState(""),[ne,ae]=n.useState(""),[u,L]=n.useState(!0),[oe,C]=n.useState(!1),[Le,le]=n.useState([]),[P,R]=n.useState(!1),[w,ce]=n.useState(null),[c,de]=n.useState([]);n.useEffect(()=>{y&&ue()},[y]);const ue=async()=>{try{J(!0);const t=(await W.getById(parseInt(y))).data;if(t){const r={id:t.id,title:t.title||"",description:t.description||"",projectUrl:t.projectUrl||"",hackathonId:t.hackathon?.id||0,teamId:t.team?.id||0,filePath:t.filePath,submitTime:t.submitTime};B(r),E(r.title),V(r.description),A(r.projectUrl);const k=ke().forHackathon(r.hackathonId).byUser(b?.id||0).title(r.title).description(r.description).projectUrl(r.projectUrl);ie(k);try{const S=(await we.getAll()).data.find(fe=>fe.id===r.hackathonId);S&&(ae(S.status),S.status==="Judging"||S.status==="Completed"?(L(!1),l(`âš ï¸ Editing is disabled during ${S.status} phase. Submissions are locked for integrity.`)):L(!0))}catch(ee){console.warn("Failed to fetch hackathon status:",ee),L(!0)}R(!0)}else l("Submission not found.")}catch(s){console.error("Failed to fetch submission:",s),l("Failed to load submission. Please try again.")}finally{J(!1)}},he=()=>{if(!v)return!1;const s=v.title(h).description(x).projectUrl(m);p&&s.file(p);const t=s.asFinalSubmission().validate();return de(t.errors),t.isValid},xe=async()=>{if(!(!he()||!i||!b))try{Q(!0),l(""),g("");const s={hackathonId:i.hackathonId,userId:b.id,submissionId:i.id,title:h.trim(),description:x.trim(),projectUrl:m.trim(),file:p};await W.edit(s),g("Submission updated successfully! ðŸŽ‰"),R(!0),B(t=>t?{...t,title:h.trim(),description:x.trim(),projectUrl:m.trim()}:null)}catch(s){console.error("Failed to save submission:",s),l("Failed to save submission. Please try again.")}finally{Q(!1)}},Z=async()=>{if(!(!i||!b))try{_(!0),l(""),g("");const s={teamId:i.teamId,submissionId:i.id,hackathonId:i.hackathonId},r=(await W.undoLastEdit(s)).data;r&&(E(r.title||""),V(r.description||""),A(r.projectUrl||""),B(k=>k?{...k,title:r.title||"",description:r.description||"",projectUrl:r.projectUrl||""}:null),g("Successfully restored previous version! â†¶"))}catch(s){console.error("Failed to undo:",s),s.response?.data?.message?.includes("No history")?(l("No previous version available to restore."),R(!1)):l("Failed to undo changes. Please try again.")}finally{_(!1)}},me=()=>{Y(`/submissions/${y}`)},pe=s=>{const t=s.target.files?.[0];if(t){if(t.size>10*1024*1024){l("File size must be less than 10MB");return}$(t)}},je=async s=>{try{if(!b||!i)return;await W.setPrimary(i.id,b.id),ce(s),g("Version set as primary submission! â­"),le(t=>t.map(r=>({...r,isPrimary:r.id===s})))}catch(t){console.error("Failed to set primary version:",t),t.response?.status===400?l("Cannot change primary submission during Judging or Completed phase."):l("Failed to set primary version. Please try again.")}},be=()=>i?[{id:Date.now(),title:h||i.title,description:x||i.description,projectUrl:m||i.projectUrl,savedAt:new Date().toISOString(),filePath:i.filePath,isPrimary:w===Date.now()||w===null},{id:Date.now()-1e3,title:"Updated Project Title v2",description:"Improved project description with more details about implementation",projectUrl:"https://github.com/team/project-v2",savedAt:new Date(Date.now()-2*60*60*1e3).toISOString(),isPrimary:w===Date.now()-1e3},{id:Date.now()-2e3,title:"Initial Project Submission",description:"First version of our hackathon project",projectUrl:"https://github.com/team/project-v1",savedAt:new Date(Date.now()-24*60*60*1e3).toISOString(),isPrimary:w===Date.now()-2e3}]:[];return re?e.jsx(q,{maxWidth:"md",sx:{mt:8,mb:4},children:e.jsx(o,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"50vh"},children:e.jsx(N,{})})}):i?e.jsxs(q,{maxWidth:"lg",sx:{mt:4,mb:6},children:[e.jsx(o,{sx:{mb:4},children:e.jsxs(o,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(ze,{sx:{fontSize:40,color:"primary.main"}}),e.jsxs(o,{children:[e.jsx(a,{variant:"h4",component:"h1",sx:{fontWeight:"bold",color:"primary.main"},children:"Edit Submission"}),e.jsxs(a,{variant:"subtitle1",color:"textSecondary",children:["Submission ID: #",i.id]})]})]}),e.jsxs(o,{sx:{display:"flex",gap:1},children:[e.jsx(D,{title:"View Version History",children:e.jsx(z,{onClick:()=>C(!0),color:"primary",sx:{bgcolor:"action.hover"},children:e.jsx(M,{})})}),e.jsx(D,{title:P?"Undo Last Change":"No changes to undo",children:e.jsx("span",{children:e.jsx(j,{variant:"outlined",startIcon:f?e.jsx(N,{size:16}):e.jsx(Te,{}),onClick:Z,disabled:f||!P,sx:{textTransform:"none"},children:f?"Undoing...":"Undo"})})})]})]})}),e.jsxs(O,{container:!0,spacing:4,children:[e.jsx(O,{item:!0,xs:12,lg:8,children:e.jsxs(ge,{elevation:3,sx:{p:4},children:[e.jsx(a,{variant:"h5",gutterBottom:!0,sx:{fontWeight:"bold",mb:3},children:"ðŸ“ Edit Project Details"}),v&&e.jsx(T,{elevation:1,sx:{mb:3,bgcolor:"grey.50"},children:e.jsxs(F,{sx:{py:2},children:[e.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(a,{variant:"h6",sx:{fontWeight:"bold"},children:["Completion: ",v.title(h).description(x).projectUrl(m).getCompletionPercentage(),"%"]}),e.jsxs(H,{direction:"row",spacing:1,children:[e.jsx(I,{label:ne||"Loading...",color:u?"success":"error",size:"small"}),u&&e.jsx(I,{label:"Editable",color:"primary",size:"small",variant:"outlined"})]})]}),e.jsx(ye,{variant:"determinate",value:v.title(h).description(x).projectUrl(m).getCompletionPercentage(),sx:{borderRadius:1,height:6}})]})}),K&&e.jsx(U,{severity:"error",sx:{mb:3},onClose:()=>l(""),children:K}),X&&e.jsx(U,{severity:"success",sx:{mb:3},onClose:()=>g(""),children:X}),c.length>0&&e.jsxs(U,{severity:"warning",sx:{mb:3},children:[e.jsx(a,{variant:"subtitle2",sx:{mb:1},children:"Please fix the following issues:"}),e.jsx("ul",{style:{margin:0,paddingLeft:20},children:c.map((s,t)=>e.jsx("li",{children:s},t))})]}),e.jsxs(H,{spacing:3,children:[e.jsx(G,{required:!0,fullWidth:!0,label:"Project Title",value:h,onChange:s=>E(s.target.value),error:!!c.find(s=>s==="Title is required")||!!c.find(s=>s==="Title must be at least 3 characters"),helperText:c.find(s=>s==="Title is required")||c.find(s=>s==="Title must be at least 3 characters")||"Give your project a descriptive title",disabled:d||!u}),e.jsx(G,{required:!0,fullWidth:!0,multiline:!0,rows:8,label:"Project Description",value:x,onChange:s=>V(s.target.value),error:!!c.find(s=>s==="Description is required")||!!c.find(s=>s==="Description must be at least 10 characters"),helperText:c.find(s=>s==="Description is required")||c.find(s=>s==="Description must be at least 10 characters")||"Describe your project's purpose, features, and technology",disabled:d||!u}),e.jsx(G,{fullWidth:!0,label:"Project URL (GitHub, Demo, etc.)",value:m,onChange:s=>A(s.target.value),helperText:"Optional: Link to your GitHub repo, live demo, or project website",disabled:d||!u}),e.jsxs(o,{children:[e.jsx(a,{variant:"subtitle1",gutterBottom:!0,sx:{fontWeight:"medium"},children:"ðŸ“Ž Update Project Files (Optional)"}),e.jsxs(j,{variant:"outlined",component:"label",startIcon:e.jsx(te,{}),disabled:d||!u,sx:{mb:1},children:["Choose New File",e.jsx("input",{type:"file",hidden:!0,onChange:pe,accept:".zip,.rar,.7z,.tar,.gz,.pdf,.doc,.docx,.txt",disabled:!u})]}),p&&e.jsx(o,{sx:{mt:1,p:2,bgcolor:"action.hover",borderRadius:1},children:e.jsxs(a,{variant:"body2",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(te,{fontSize:"small"}),"New file: ",e.jsx("strong",{children:p.name})," (",(p.size/1024/1024).toFixed(2)," MB)",e.jsx(z,{size:"small",onClick:()=>$(null),children:e.jsx(Fe,{fontSize:"small"})})]})}),i.filePath&&!p&&e.jsx(o,{sx:{mt:1,p:2,bgcolor:"grey.50",borderRadius:1},children:e.jsxs(a,{variant:"body2",color:"textSecondary",children:["Current file: ",i.filePath.split("/").pop()?.replace(/^\d+_/,"")||"Unknown"]})})]}),e.jsxs(o,{sx:{display:"flex",gap:2,pt:2},children:[e.jsx(j,{variant:"contained",size:"large",startIcon:d?e.jsx(N,{size:16}):e.jsx(He,{}),onClick:xe,disabled:d||f||!u,sx:{textTransform:"none"},children:d?"Saving...":"Save Changes"}),e.jsx(j,{variant:"outlined",size:"large",startIcon:e.jsx(We,{}),onClick:me,disabled:d||f,sx:{textTransform:"none"},children:"Cancel"})]})]})]})}),e.jsxs(O,{item:!0,xs:12,lg:4,children:[e.jsx(T,{elevation:2,children:e.jsxs(F,{children:[e.jsx(a,{variant:"h6",gutterBottom:!0,sx:{fontWeight:"bold"},children:"ðŸ§  Version Control"}),e.jsx(se,{sx:{mb:2}}),e.jsx(a,{variant:"body2",color:"textSecondary",sx:{mb:2},children:"Save your changes to create new versions. You can undo changes to restore previous versions."}),e.jsxs(o,{sx:{mb:2},children:[e.jsx(a,{variant:"body2",sx:{fontWeight:"medium"},children:"Last Modified:"}),e.jsx(a,{variant:"body2",color:"textSecondary",children:i.submitTime?new Date(i.submitTime).toLocaleString():"Unknown"})]}),e.jsxs(o,{sx:{mb:3},children:[e.jsx(a,{variant:"body2",sx:{fontWeight:"medium"},children:"Undo Available:"}),e.jsx(I,{label:P?"Yes":"No",color:P?"success":"default",size:"small"})]}),e.jsx(j,{variant:"text",startIcon:e.jsx(M,{}),onClick:()=>C(!0),fullWidth:!0,sx:{textTransform:"none"},children:"View Version History"})]})}),e.jsx(T,{elevation:2,sx:{mt:2},children:e.jsxs(F,{children:[e.jsx(a,{variant:"h6",gutterBottom:!0,sx:{fontWeight:"bold"},children:"ðŸš€ Quick Actions"}),e.jsx(se,{sx:{mb:2}}),e.jsx(H,{spacing:1,children:e.jsx(j,{variant:"outlined",startIcon:e.jsx(Be,{}),onClick:()=>Y(`/submissions/${y}`),fullWidth:!0,sx:{textTransform:"none"},children:"Preview Submission"})})]})})]})]}),e.jsxs(ve,{open:oe,onClose:()=>C(!1),maxWidth:"md",fullWidth:!0,children:[e.jsxs(Se,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(M,{}),"Version History"]}),e.jsxs(Ie,{children:[e.jsx(a,{variant:"body2",color:"textSecondary",sx:{mb:3},children:"Here are the recent versions of your submission. You can restore any previous version."}),e.jsx(H,{spacing:2,children:be().map((s,t)=>e.jsx(T,{elevation:1,sx:{bgcolor:s.isPrimary?"primary.light":t===0?"action.selected":"background.paper",border:s.isPrimary?2:1,borderColor:s.isPrimary?"primary.main":"divider"},children:e.jsx(F,{sx:{pb:2},children:e.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:1},children:[e.jsxs(o,{sx:{flex:1},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1,mb:1},children:[e.jsx(a,{variant:"subtitle1",sx:{fontWeight:"medium"},children:s.title}),t===0&&e.jsx(I,{label:"Current",size:"small",color:"primary"}),s.isPrimary&&e.jsx(I,{label:"Primary",size:"small",color:"warning",icon:e.jsx(Ee,{})})]}),e.jsx(a,{variant:"body2",color:"textSecondary",sx:{mb:1},children:s.description}),e.jsxs(a,{variant:"caption",color:"textSecondary",children:["Saved: ",new Date(s.savedAt).toLocaleString()]})]}),e.jsxs(o,{sx:{display:"flex",flexDirection:"column",gap:1,ml:2},children:[!s.isPrimary&&e.jsx(D,{title:"Set as Primary Submission",children:e.jsx(z,{size:"small",color:"warning",onClick:()=>je(s.id),children:e.jsx(Ve,{fontSize:"small"})})}),t!==0&&e.jsx(D,{title:"Restore this version",children:e.jsx(z,{size:"small",color:"primary",onClick:Z,disabled:f,children:e.jsx(Ae,{fontSize:"small"})})})]})]})})},s.id))})]}),e.jsx(Ce,{children:e.jsx(j,{onClick:()=>C(!1),children:"Close"})})]})]}):e.jsx(q,{maxWidth:"md",sx:{mt:8,mb:4},children:e.jsx(U,{severity:"error",children:"Submission not found or you don't have permission to edit it."})})};export{$e as default};
