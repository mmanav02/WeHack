import{r,j as e,C as V,B as a,l as A,w as B,i as o,O as C,I as w,h as d,G as R,P as fe,S as L,v as N,m as O,n as q,y as se,o as G,p as be,q as ge,s as ye,t as ve}from"./mui-6pu-mHHs.js";import{u as Se,s as k,h as Ie}from"./index-CeQrkf_Y.js";import{b as Pe,u as Ce}from"./router-Btts6DUI.js";import{E as we,H as M,U as ke,F as ie,D as De,S as Ue,R as Te,P as ze,a as Fe,b as He,c as We}from"./mui-icons-ByUxv65T.js";import"./react--cgwBsGs.js";import"./api-xsH4HHeE.js";const qe=()=>{const{submissionId:p}=Pe(),Y=Ce(),{user:j}=Se(),[i,D]=r.useState(null),[u,U]=r.useState(""),[h,T]=r.useState(""),[v,z]=r.useState(""),[f,$]=r.useState(null),[re,J]=r.useState(!0),[c,Q]=r.useState(!1),[m,_]=r.useState(!1),[K,l]=r.useState(""),[X,b]=r.useState(""),[Ee,ne]=r.useState(""),[x,F]=r.useState(!0),[ae,S]=r.useState(!1),[Ve,oe]=r.useState([]),[I,H]=r.useState(!1),[P,le]=r.useState(null),[Z,W]=r.useState(""),[ee,E]=r.useState("");r.useEffect(()=>{p&&ce()},[p]);const ce=async()=>{try{J(!0);const s=(await k.getById(parseInt(p))).data;if(s){const n={id:s.id,title:s.title||"",description:s.description||"",projectUrl:s.projectUrl||"",hackathonId:s.hackathon?.id||0,teamId:s.team?.id||0,filePath:s.filePath,submitTime:s.submitTime};D(n),U(n.title),T(n.description),z(n.projectUrl);try{const y=(await Ie.getAll()).data.find(je=>je.id===n.hackathonId);y&&(ne(y.status),y.status==="Judging"||y.status==="Completed"?(F(!1),l(`⚠️ Editing is disabled during ${y.status} phase. Submissions are locked for integrity.`)):F(!0))}catch(g){console.warn("Failed to fetch hackathon status:",g),F(!0)}H(!0)}else l("Submission not found.")}catch(t){console.error("Failed to fetch submission:",t),l("Failed to load submission. Please try again.")}finally{J(!1)}},de=()=>{let t=!0;return W(""),E(""),u.trim()?u.length<3&&(W("Title must be at least 3 characters"),t=!1):(W("Title is required"),t=!1),h.trim()?h.length<10&&(E("Description must be at least 10 characters"),t=!1):(E("Description is required"),t=!1),t},ue=async()=>{if(!(!de()||!i||!j))try{Q(!0),l(""),b("");const t={hackathonId:i.hackathonId,userId:j.id,submissionId:i.id,title:u.trim(),description:h.trim(),projectUrl:v.trim(),file:f};await k.edit(t),b("Submission updated successfully! 🎉"),H(!0),D(s=>s?{...s,title:u.trim(),description:h.trim(),projectUrl:v.trim()}:null)}catch(t){console.error("Failed to save submission:",t),l("Failed to save submission. Please try again.")}finally{Q(!1)}},te=async()=>{if(!(!i||!j))try{_(!0),l(""),b("");const t={teamId:i.teamId,submissionId:i.id,hackathonId:i.hackathonId},n=(await k.undoLastEdit(t)).data;n&&(U(n.title||""),T(n.description||""),z(n.projectUrl||""),D(g=>g?{...g,title:n.title||"",description:n.description||"",projectUrl:n.projectUrl||""}:null),b("Successfully restored previous version! ↶"))}catch(t){console.error("Failed to undo:",t),t.response?.data?.message?.includes("No history")?(l("No previous version available to restore."),H(!1)):l("Failed to undo changes. Please try again.")}finally{_(!1)}},he=()=>{Y(`/submissions/${p}`)},me=t=>{const s=t.target.files?.[0];if(s){if(s.size>10*1024*1024){l("File size must be less than 10MB");return}$(s)}},xe=async t=>{try{if(!j||!i)return;await k.setPrimary(i.id,j.id),le(t),b("Version set as primary submission! ⭐"),oe(s=>s.map(n=>({...n,isPrimary:n.id===t})))}catch(s){console.error("Failed to set primary version:",s),s.response?.status===400?l("Cannot change primary submission during Judging or Completed phase."):l("Failed to set primary version. Please try again.")}},pe=()=>i?[{id:Date.now(),title:u||i.title,description:h||i.description,projectUrl:v||i.projectUrl,savedAt:new Date().toISOString(),filePath:i.filePath,isPrimary:P===Date.now()||P===null},{id:Date.now()-1e3,title:"Updated Project Title v2",description:"Improved project description with more details about implementation",projectUrl:"https://github.com/team/project-v2",savedAt:new Date(Date.now()-2*60*60*1e3).toISOString(),isPrimary:P===Date.now()-1e3},{id:Date.now()-2e3,title:"Initial Project Submission",description:"First version of our hackathon project",projectUrl:"https://github.com/team/project-v1",savedAt:new Date(Date.now()-24*60*60*1e3).toISOString(),isPrimary:P===Date.now()-2e3}]:[];return re?e.jsx(V,{maxWidth:"md",sx:{mt:8,mb:4},children:e.jsx(a,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"50vh"},children:e.jsx(A,{})})}):i?e.jsxs(V,{maxWidth:"lg",sx:{mt:4,mb:6},children:[e.jsx(a,{sx:{mb:4},children:e.jsxs(a,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2},children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(we,{sx:{fontSize:40,color:"primary.main"}}),e.jsxs(a,{children:[e.jsx(o,{variant:"h4",component:"h1",sx:{fontWeight:"bold",color:"primary.main"},children:"Edit Submission"}),e.jsxs(o,{variant:"subtitle1",color:"textSecondary",children:["Submission ID: #",i.id]})]})]}),e.jsxs(a,{sx:{display:"flex",gap:1},children:[e.jsx(C,{title:"View Version History",children:e.jsx(w,{onClick:()=>S(!0),color:"primary",sx:{bgcolor:"action.hover"},children:e.jsx(M,{})})}),e.jsx(C,{title:I?"Undo Last Change":"No changes to undo",children:e.jsx("span",{children:e.jsx(d,{variant:"outlined",startIcon:m?e.jsx(A,{size:16}):e.jsx(ke,{}),onClick:te,disabled:m||!I,sx:{textTransform:"none"},children:m?"Undoing...":"Undo"})})})]})]})}),e.jsxs(R,{container:!0,spacing:4,children:[e.jsx(R,{item:!0,xs:12,lg:8,children:e.jsxs(fe,{elevation:3,sx:{p:4},children:[e.jsx(o,{variant:"h5",gutterBottom:!0,sx:{fontWeight:"bold",mb:3},children:"📝 Edit Project Details"}),K&&e.jsx(B,{severity:"error",sx:{mb:3},children:K}),X&&e.jsx(B,{severity:"success",sx:{mb:3},children:X}),e.jsxs(L,{spacing:3,children:[e.jsx(N,{required:!0,fullWidth:!0,label:"Project Title",value:u,onChange:t=>U(t.target.value),error:!!Z,helperText:Z||"Give your project a descriptive title",disabled:c||!x}),e.jsx(N,{required:!0,fullWidth:!0,multiline:!0,rows:8,label:"Project Description",value:h,onChange:t=>T(t.target.value),error:!!ee,helperText:ee||"Describe your project's purpose, features, and technology",disabled:c||!x}),e.jsx(N,{fullWidth:!0,label:"Project URL (GitHub, Demo, etc.)",value:v,onChange:t=>z(t.target.value),helperText:"Optional: Link to your GitHub repo, live demo, or project website",disabled:c||!x}),e.jsxs(a,{children:[e.jsx(o,{variant:"subtitle1",gutterBottom:!0,sx:{fontWeight:"medium"},children:"📎 Update Project Files (Optional)"}),e.jsxs(d,{variant:"outlined",component:"label",startIcon:e.jsx(ie,{}),disabled:c||!x,sx:{mb:1},children:["Choose New File",e.jsx("input",{type:"file",hidden:!0,onChange:me,accept:".zip,.rar,.7z,.tar,.gz,.pdf,.doc,.docx,.txt",disabled:!x})]}),f&&e.jsx(a,{sx:{mt:1,p:2,bgcolor:"action.hover",borderRadius:1},children:e.jsxs(o,{variant:"body2",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ie,{fontSize:"small"}),"New file: ",e.jsx("strong",{children:f.name})," (",(f.size/1024/1024).toFixed(2)," MB)",e.jsx(w,{size:"small",onClick:()=>$(null),children:e.jsx(De,{fontSize:"small"})})]})}),i.filePath&&!f&&e.jsx(a,{sx:{mt:1,p:2,bgcolor:"grey.50",borderRadius:1},children:e.jsxs(o,{variant:"body2",color:"textSecondary",children:["Current file: ",i.filePath.split("/").pop()?.replace(/^\d+_/,"")||"Unknown"]})})]}),e.jsxs(a,{sx:{display:"flex",gap:2,pt:2},children:[e.jsx(d,{variant:"contained",size:"large",startIcon:c?e.jsx(A,{size:16}):e.jsx(Ue,{}),onClick:ue,disabled:c||m||!x,sx:{textTransform:"none"},children:c?"Saving...":"Save Changes"}),e.jsx(d,{variant:"outlined",size:"large",startIcon:e.jsx(Te,{}),onClick:he,disabled:c||m,sx:{textTransform:"none"},children:"Cancel"})]})]})]})}),e.jsxs(R,{item:!0,xs:12,lg:4,children:[e.jsx(O,{elevation:2,children:e.jsxs(q,{children:[e.jsx(o,{variant:"h6",gutterBottom:!0,sx:{fontWeight:"bold"},children:"🧠 Version Control"}),e.jsx(se,{sx:{mb:2}}),e.jsx(o,{variant:"body2",color:"textSecondary",sx:{mb:2},children:"Your changes are automatically saved as versions. You can undo changes to restore previous versions."}),e.jsxs(a,{sx:{mb:2},children:[e.jsx(o,{variant:"body2",sx:{fontWeight:"medium"},children:"Last Modified:"}),e.jsx(o,{variant:"body2",color:"textSecondary",children:i.submitTime?new Date(i.submitTime).toLocaleString():"Unknown"})]}),e.jsxs(a,{sx:{mb:3},children:[e.jsx(o,{variant:"body2",sx:{fontWeight:"medium"},children:"Undo Available:"}),e.jsx(G,{label:I?"Yes":"No",color:I?"success":"default",size:"small"})]}),e.jsx(d,{variant:"text",startIcon:e.jsx(M,{}),onClick:()=>S(!0),fullWidth:!0,sx:{textTransform:"none"},children:"View Version History"})]})}),e.jsx(O,{elevation:2,sx:{mt:2},children:e.jsxs(q,{children:[e.jsx(o,{variant:"h6",gutterBottom:!0,sx:{fontWeight:"bold"},children:"🚀 Quick Actions"}),e.jsx(se,{sx:{mb:2}}),e.jsx(L,{spacing:1,children:e.jsx(d,{variant:"outlined",startIcon:e.jsx(ze,{}),onClick:()=>Y(`/submissions/${p}`),fullWidth:!0,sx:{textTransform:"none"},children:"Preview Submission"})})]})})]})]}),e.jsxs(be,{open:ae,onClose:()=>S(!1),maxWidth:"md",fullWidth:!0,children:[e.jsxs(ge,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(M,{}),"Version History"]}),e.jsxs(ye,{children:[e.jsx(o,{variant:"body2",color:"textSecondary",sx:{mb:3},children:"Here are the recent versions of your submission. You can restore any previous version."}),e.jsx(L,{spacing:2,children:pe().map((t,s)=>e.jsx(O,{elevation:1,sx:{bgcolor:t.isPrimary?"primary.light":s===0?"action.selected":"background.paper",border:t.isPrimary?2:1,borderColor:t.isPrimary?"primary.main":"divider"},children:e.jsx(q,{sx:{pb:2},children:e.jsxs(a,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:1},children:[e.jsxs(a,{sx:{flex:1},children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:1,mb:1},children:[e.jsx(o,{variant:"subtitle1",sx:{fontWeight:"medium"},children:t.title}),s===0&&e.jsx(G,{label:"Current",size:"small",color:"primary"}),t.isPrimary&&e.jsx(G,{label:"Primary",size:"small",color:"warning",icon:e.jsx(Fe,{})})]}),e.jsx(o,{variant:"body2",color:"textSecondary",sx:{mb:1},children:t.description}),e.jsxs(o,{variant:"caption",color:"textSecondary",children:["Saved: ",new Date(t.savedAt).toLocaleString()]})]}),e.jsxs(a,{sx:{display:"flex",flexDirection:"column",gap:1,ml:2},children:[!t.isPrimary&&e.jsx(C,{title:"Set as Primary Submission",children:e.jsx(w,{size:"small",color:"warning",onClick:()=>xe(t.id),children:e.jsx(He,{fontSize:"small"})})}),s!==0&&e.jsx(C,{title:"Restore this version",children:e.jsx(w,{size:"small",color:"primary",onClick:te,disabled:m,children:e.jsx(We,{fontSize:"small"})})})]})]})})},t.id))})]}),e.jsx(ve,{children:e.jsx(d,{onClick:()=>S(!1),children:"Close"})})]})]}):e.jsx(V,{maxWidth:"md",sx:{mt:8,mb:4},children:e.jsx(B,{severity:"error",children:"Submission not found or you don't have permission to edit it."})})};export{qe as default};
